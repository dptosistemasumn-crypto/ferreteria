<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferretería App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <style>
        body { background-color: #f8f9fa; }
        .product-img {
            height: 200px;
            object-fit: contain; /* Para que las herramientas se vean completas */
            padding: 10px;
            background: white;
        }
        .cart-float {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        .card { transition: transform 0.2s; }
        .card:hover { transform: translateY(-5px); shadow: 0 4px 8px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-primary sticky-top">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1"><i class="bi bi-tools"></i> Mi Ferretería</span>
            <button class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#trackingModal">
                <i class="bi bi-search"></i> Rastrear
            </button>
        </div>
    </nav>

    <div class="container py-4">
        
        <div class="row mb-4">
            <div class="col-12 col-md-6 mx-auto">
                <input type="text" id="searchInput" class="form-control" placeholder="Buscar tornillos, martillos...">
            </div>
        </div>

        <div id="product-container" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
            <div class="text-center w-100 mt-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p>Cargando inventario...</p>
            </div>
        </div>
    </div>

    <button class="btn btn-success rounded-circle p-3 cart-float shadow" data-bs-toggle="modal" data-bs-target="#cartModal">
        <i class="bi bi-whatsapp fs-3"></i>
        <span id="cart-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
            0
        </span>
    </button>

    <div class="modal fade" id="cartModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Tu Pedido</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul id="cart-items" class="list-group mb-3">
                        <li class="list-group-item text-center">El carrito está vacío</li>
                    </ul>
                    <div class="d-flex justify-content-between fw-bold">
                        <span>Total:</span>
                        <span id="cart-total">$0</span>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <label class="form-label">Tu Nombre</label>
                        <input type="text" id="clientName" class="form-control" placeholder="Juan Pérez">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button onclick="sendOrder()" class="btn btn-success">Enviar a WhatsApp</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="trackingModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Rastrear Pedido</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="orderIdInput" class="form-control mb-2" placeholder="Ingresa tu ID de pedido (Ej: ORD-123)">
                    <button onclick="checkOrder()" class="btn btn-primary w-100">Buscar</button>
                    <div id="trackingResult" class="mt-3 alert alert-info d-none"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ---------------- CONFIGURACIÓN ----------------
        // PEGA AQUÍ LA URL DE TU APPS SCRIPT (LA QUE TERMINA EN /exec)
        const SCRIPT_URL = 'https://script.google.com/macros/s/TU_URL_LARGA_AQUI/exec';
        const WHATSAPP_PHONE = '573001234567'; // Tu número de ferretería
        // -----------------------------------------------

        let products = [];
        let cart = JSON.parse(localStorage.getItem('ferreteriaCart')) || [];

        // Iniciar
        document.addEventListener('DOMContentLoaded', () => {
            fetchProducts();
            updateCartUI();
        });

        // 1. Obtener Productos de Google Sheets
        async function fetchProducts() {
            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();
                products = data;
                renderProducts(products);
            } catch (error) {
                console.error('Error cargando productos:', error);
                document.getElementById('product-container').innerHTML = '<p class="text-danger text-center">Error de conexión con el inventario.</p>';
            }
        }

        // 2. Renderizar (Mostrar) Productos
        function renderProducts(list) {
            const container = document.getElementById('product-container');
            container.innerHTML = '';
            
            list.forEach(prod => {
                // Tarjeta Responsiva
                const card = `
                <div class="col">
                    <div class="card h-100 shadow-sm">
                        <img src="${prod.Imagen_URL}" class="product-img card-img-top" alt="${prod.Nombre}" onerror="this.src='https://via.placeholder.com/200?text=Sin+Foto'">
                        <div class="card-body d-flex flex-col form-column">
                            <h5 class="card-title text-truncate">${prod.Nombre}</h5>
                            <p class="card-text text-muted small">${prod.Categoria}</p>
                            <h4 class="text-primary fw-bold">$${prod.Precio}</h4>
                            <button onclick="addToCart('${prod.ID}')" class="btn btn-outline-primary w-100 mt-auto">
                                <i class="bi bi-cart-plus"></i> Agregar
                            </button>
                        </div>
                    </div>
                </div>`;
                container.innerHTML += card;
            });
        }

        // Buscador simple
        document.getElementById('searchInput').addEventListener('keyup', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = products.filter(p => p.Nombre.toLowerCase().includes(term));
            renderProducts(filtered);
        });

        // 3. Lógica del Carrito
        function addToCart(id) {
            const product = products.find(p => p.ID === id);
            cart.push(product);
            saveCart();
            updateCartUI();
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            saveCart();
            updateCartUI();
        }

        function saveCart() {
            localStorage.setItem('ferreteriaCart', JSON.stringify(cart));
        }

        function updateCartUI() {
            document.getElementById('cart-count').innerText = cart.length;
            const list = document.getElementById('cart-items');
            const totalElem = document.getElementById('cart-total');
            
            list.innerHTML = '';
            let total = 0;

            if(cart.length === 0) {
                list.innerHTML = '<li class="list-group-item text-center">Carrito vacío</li>';
            } else {
                cart.forEach((item, index) => {
                    total += parseInt(item.Precio);
                    list.innerHTML += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <small class="fw-bold">${item.Nombre}</small><br>
                            <small class="text-muted">$${item.Precio}</small>
                        </div>
                        <button onclick="removeFromCart(${index})" class="btn btn-sm btn-danger">&times;</button>
                    </li>`;
                });
            }
            totalElem.innerText = '$' + total;
        }

        // 4. Enviar Pedido (WhatsApp + Sheets)
        async function sendOrder() {
            const name = document.getElementById('clientName').value;
            if(!name || cart.length === 0) {
                alert('Por favor agrega productos y tu nombre.');
                return;
            }

            const btn = document.querySelector('#cartModal .btn-success');
            btn.innerHTML = 'Enviando...';
            btn.disabled = true;

            const total = cart.reduce((sum, item) => sum + parseInt(item.Precio), 0);
            const detailText = cart.map(i => i.Nombre).join(', ');

            const orderData = {
                nombre: name,
                telefono: 'WhatsApp', // Se asume al llegar el mensaje
                detalle: detailText,
                total: total
            };

            try {
                // Guardar en Sheets primero para generar ID
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(orderData)
                });
                const result = await response.json();
                
                // Generar mensaje de WhatsApp
                const msg = `Hola, soy *${name}*. Quiero confirmar mi pedido *${result.idPedido}*.\n\nProductos: ${detailText}\n\n*Total: $${total}*`;
                
                // Limpiar carrito y redirigir
                cart = [];
                saveCart();
                updateCartUI();
                
                window.open(`https://wa.me/${WHATSAPP_PHONE}?text=${encodeURIComponent(msg)}`, '_blank');
                
                // Cerrar modal
                const modalEl = document.getElementById('cartModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();

            } catch (error) {
                console.error(error);
                alert('Error al procesar el pedido.');
            } finally {
                btn.innerHTML = 'Enviar a WhatsApp';
                btn.disabled = false;
            }
        }
        
        // 5. Rastreo (Versión Simple - Requiere que implementes GET con params en Apps Script,
        // o traer todos los pedidos y filtrar aquí. Esta versión asume traer todos por simplicidad
        // en este ejemplo, aunque para producción es mejor filtrar en backend).
        async function checkOrder() {
           // Nota: Para que esto funcione, tu doGet en Apps Script debe devolver también los pedidos
           // o tener un endpoint separado. Por ahora, simulemos la alerta visual.
           const id = document.getElementById('orderIdInput').value;
           const resultBox = document.getElementById('trackingResult');
           
           if(!id) return;

           resultBox.classList.remove('d-none');
           resultBox.innerHTML = 'Consultando...';
           
           // Aquí harías fetch buscando el ID.
           // Ejemplo visual:
           setTimeout(() => {
               resultBox.innerHTML = `El estado del pedido <b>${id}</b> es: <br><span class="badge bg-warning text-dark">Pendiente</span>`;
           }, 1000);
        }

    </script>
</body>
</html>
